
describe("Geometry editor dialog", function() {

  var dialog, row, the_geom;
  beforeEach(function() {

    the_geom = '{"type":"MultiPolygon","coordinates":[[[[45.573051,40.632488],[45.528881,40.606098],[45.51305,40.60722],[45.499161,40.61694],[45.49194,40.63694],[45.501389,40.658039],[45.51749,40.665539],[45.55534,40.665371],[45.572491,40.663052],[45.58749,40.653881],[45.588329,40.648331],[45.573051,40.632488]]],[[[45.15387,41.198601],[45.193047,41.17305],[45.211372,41.159714],[45.218323,41.151649],[45.222755,41.14193],[45.222755,41.135818],[45.220543,41.130547],[45.216385,41.126938],[45.20665,41.120827],[45.201096,41.118317],[45.19471,41.116936],[45.179993,41.114998],[45.171928,41.114998],[45.136375,41.117203],[45.128319,41.118599],[45.11055,41.119713],[45.087769,41.11776],[45.081383,41.116096],[45.076653,41.113045],[45.074158,41.107773],[45.073318,41.101105],[45.077766,41.085258],[45.082207,41.075554],[45.09137,41.062759],[45.101379,41.056656],[45.336937,41.001656],[45.344994,41.000542],[45.3536,41],[45.368317,41.001656],[45.614159,40.875542],[45.61805,40.871933],[45.622208,40.862206],[45.623322,40.856659],[45.620827,40.84388],[45.615273,40.828049],[45.606377,40.806374],[45.603882,40.801384],[45.594147,40.787766],[45.57972,40.778603],[45.574158,40.776375],[45.523315,40.763054],[45.455544,40.74221],[45.443604,40.738319],[45.429153,40.729149],[45.421928,40.722214],[45.418877,40.717766],[45.391373,40.675819],[45.388329,40.671097],[45.386658,40.665268],[45.386932,40.659157],[45.389153,40.648331],[45.391106,40.643326],[45.413605,40.60804],[45.532494,40.460541],[45.540276,40.453316],[45.638039,40.391106],[45.662766,40.375824],[45.875824,40.269707],[45.888596,40.265266],[45.906151,40.263451],[45.92054,40.265549],[45.951653,40.273872],[45.958321,40.272217],[45.962494,40.268593],[45.993874,40.239159],[45.999718,40.230537],[46.001938,40.225548],[46.002769,40.220261],[46.001938,40.213608],[45.979424,40.122208],[45.976929,40.116936],[45.973877,40.112488],[45.9161,40.033333],[45.909424,40.024437],[45.90554,40.020546],[45.900826,40.017487],[45.888039,40.014435],[45.873047,40.013611],[45.847771,40.016106],[45.824432,40.019981],[45.763611,40.024437],[45.713608,40.026093],[45.681931,40.025826],[45.638039,40.02166],[45.613602,40.014435],[45.603882,40.007767],[45.599991,40.004166],[45.593597,39.994987],[45.592766,39.982491],[45.595818,39.978043],[45.605553,39.971924],[45.611382,39.969437],[45.618317,39.967766],[45.705269,39.961372],[45.729706,39.958321],[45.751099,39.953316],[45.774437,39.943604],[45.784157,39.937485],[45.793877,39.925262],[45.799988,39.910538],[45.802216,39.899712],[45.807213,39.884438],[45.816376,39.86554],[45.819153,39.861382],[45.829163,39.849152],[45.844704,39.834435],[45.856659,39.823601],[45.876099,39.811371],[45.886658,39.805817],[45.908875,39.795273],[45.926384,39.788048],[45.960274,39.778603],[45.983871,39.777489],[45.999161,39.774994],[46.006104,39.773041],[46.010818,39.769981],[46.018593,39.762772],[46.03054,39.745537],[46.04332,39.723038],[46.05304,39.704712],[46.056099,39.700539],[46.067772,39.689423],[46.189713,39.607216],[46.204163,39.598038],[46.211098,39.5961],[46.227211,39.594147],[46.24305,39.594147],[46.250275,39.594994],[46.256386,39.596657],[46.300819,39.614441],[46.30555,39.617493],[46.311104,39.619713],[46.323044,39.623604],[46.335815,39.626656],[46.349991,39.628036],[46.364441,39.624985],[46.519981,39.58194],[46.53054,39.576096],[46.534431,39.572495],[46.541382,39.564438],[46.546944,39.549988],[46.54805,39.544434],[46.546387,39.538605],[46.519981,39.480263],[46.516663,39.475815],[46.511932,39.472755],[46.500832,39.468323],[46.494431,39.466927],[46.448601,39.457764],[46.407761,39.451653],[46.400826,39.450829],[46.395264,39.448601],[46.385818,39.442757],[46.382484,39.438324],[46.380547,39.424988],[46.381653,39.413605],[46.386658,39.398331],[46.392487,39.389709],[46.40387,39.378593],[46.557487,39.26915],[46.581383,39.253609],[46.620537,39.229424],[46.62249,39.224709],[46.620827,39.219986],[46.616096,39.217209],[46.54554,39.189423],[46.537766,39.189423],[46.496094,39.203606],[46.46666,39.215546],[46.459984,39.217484],[46.452209,39.21859],[46.444427,39.21859],[46.431107,39.216385],[46.425545,39.214149],[46.421928,39.211655],[46.418602,39.20665],[46.4161,39.201378],[46.415268,39.188881],[46.417206,39.177773],[46.421097,39.168053],[46.423882,39.163872],[46.435547,39.152771],[46.458321,39.142769],[46.477486,39.136658],[46.488884,39.131653],[46.493607,39.128593],[46.49749,39.124985],[46.500275,39.120537],[46.515831,39.081657],[46.519707,39.065819],[46.523598,39.044159],[46.520264,39.032204],[46.511932,39.017487],[46.505547,39.008041],[46.498871,38.991653],[46.494431,38.965828],[46.494713,38.959717],[46.495537,38.95443],[46.49749,38.949425],[46.540375,38.875587],[46.516388,38.878036],[46.451935,38.889992],[46.376381,38.906937],[46.354706,38.910538],[46.347481,38.909424],[46.294716,38.895821],[46.273598,38.885262],[46.263611,38.879433],[46.250275,38.869431],[46.239716,38.864159],[46.195534,38.844147],[46.178246,38.841148],[46.123604,38.909981],[46.107216,38.936104],[45.970261,39.166382],[45.967209,39.18277],[45.966927,39.188881],[45.971924,39.20665],[45.982201,39.219437],[45.989983,39.226646],[46.003609,39.236382],[46.009995,39.24527],[46.008881,39.250832],[46,39.263611],[45.99221,39.270821],[45.978043,39.279984],[45.855553,39.348038],[45.826653,39.437485],[45.829163,39.442757],[45.829987,39.449425],[45.829987,39.455544],[45.823044,39.545273],[45.819984,39.549721],[45.811371,39.556374],[45.800545,39.561928],[45.783333,39.569153],[45.755272,39.576653],[45.740822,39.57972],[45.732201,39.580544],[45.725266,39.57972],[45.626656,39.55999],[45.607773,39.554703],[45.590546,39.548607],[45.558327,39.533875],[45.528328,39.517212],[45.507767,39.506653],[45.496941,39.502213],[45.472481,39.494431],[45.457497,39.493607],[45.330826,39.535271],[45.326096,39.538322],[45.319984,39.546944],[45.266388,39.611107],[45.083321,39.768044],[45.073601,39.774155],[45.061928,39.77887],[45.054153,39.779984],[45.039986,39.778328],[45.028046,39.774437],[45.014153,39.765266],[45,39.753006],[44.99749,39.750832],[44.969147,39.732491],[44.951935,39.726372],[44.933044,39.721375],[44.92054,39.718323],[44.896378,39.7211],[44.882767,39.724709],[44.85833,39.724991],[44.799164,39.712769],[44.789398,39.709698],[44.778862,39.706383],[44.746101,39.730553],[44.648888,39.799721],[44.633881,39.80777],[44.594162,39.830544],[44.590828,39.833054],[44.560265,39.879433],[44.55471,39.888611],[44.551941,39.895264],[44.552216,39.898888],[44.548325,39.912209],[44.487778,39.962769],[44.399155,40.003609],[44.35611,40.020554],[44.347214,40.023888],[44.285271,40.046097],[44.279999,40.046097],[44.052208,40.013054],[44.040543,40.008606],[44.032219,40.006653],[43.971375,40.010818],[43.933884,40.013611],[43.912491,40.0186],[43.673607,40.100822],[43.668877,40.102486],[43.657494,40.108597],[43.648888,40.119713],[43.647774,40.122765],[43.648331,40.126381],[43.650269,40.130547],[43.657776,40.139709],[43.663849,40.144463],[43.670547,40.148041],[43.681931,40.152489],[43.707764,40.152222],[43.711937,40.153328],[43.719719,40.15638],[43.721657,40.159714],[43.721657,40.163322],[43.720543,40.166939],[43.661652,40.274437],[43.606934,40.368889],[43.583054,40.451111],[43.592766,40.501099],[43.653046,40.53138],[43.71666,40.619156],[43.719208,40.622681],[43.741379,40.666656],[43.751938,40.739998],[43.748878,40.75],[43.742493,40.770264],[43.673325,40.924988],[43.671654,40.928055],[43.606377,40.988319],[43.599434,40.992493],[43.590546,40.995827],[43.584435,40.996666],[43.581135,40.996418],[43.569443,40.995544],[43.559166,40.996666],[43.554153,40.998047],[43.493599,41.01693],[43.485268,41.020554],[43.479156,41.025269],[43.477486,41.028328],[43.453888,41.090271],[43.453888,41.097214],[43.454987,41.101944],[43.46077,41.112961],[43.546387,41.134995],[43.561661,41.136375],[43.578606,41.13472],[43.599709,41.129715],[43.637497,41.123047],[43.734428,41.113602],[43.752213,41.112488],[43.760277,41.112762],[43.782204,41.115822],[43.794991,41.119156],[43.806099,41.123871],[43.828331,41.141106],[43.836937,41.148041],[43.840828,41.151932],[43.850548,41.158043],[43.862488,41.162209],[43.884438,41.165268],[43.900536,41.165543],[43.99276,41.164146],[44.122765,41.181931],[44.144707,41.18499],[44.157494,41.188324],[44.174431,41.195534],[44.178322,41.199158],[44.18055,41.20443],[44.248871,41.223595],[44.340546,41.212494],[44.429993,41.192215],[44.484154,41.187759],[44.562202,41.185265],[44.570267,41.185265],[44.7286,41.212212],[44.824715,41.212494],[44.848877,41.213051],[44.863602,41.214706],[44.875824,41.21859],[44.9786,41.270264],[45.022942,41.29705],[45.046944,41.223312],[45.131927,41.203606],[45.140831,41.202766],[45.147774,41.201096],[45.15387,41.198601]],[[45.009991,41.033051],[45.025829,41.030548],[45.045269,41.035271],[45.054161,41.042221],[45.05888,41.052769],[45.051659,41.066669],[45.03027,41.084991],[45.01749,41.089161],[45.00111,41.088879],[44.984161,41.08194],[44.980549,41.064709],[44.98777,41.050541],[45.009991,41.033051]],[[45.19582,40.997768],[45.194988,40.9911],[45.206379,40.979431],[45.22916,40.969151],[45.24527,40.97694],[45.24527,40.983051],[45.236938,40.990269],[45.212608,41.004162],[45.204708,41.004711],[45.19582,40.997768]]]]}'
    row = new cdb.admin.Row({cartodb_id: "1", isGeomLoaded: false, the_geom: the_geom});

    dialog = new cdb.admin.EditGeometryDialog({
      el: $('<div>'),
      row: row,
      initial_value: "GeoJSON",
      readOnly: false
    });
    dialog.ok = function() {};
    dialog.cancel = function() {};
    dialog.hide = function() {};
    spyOn(dialog, 'ok');
    spyOn(dialog, 'cancel');
    spyOn(dialog, 'hide');
  });

  it("geometry dialog should work when saves", function() {
    runs(function(){
      dialog.open();
    })

    waits(500);

    runs(function(){
      dialog.$el.find("textarea").val(the_geom);
      dialog.$el.find("a.button").click();
      expect(dialog.ok).toHaveBeenCalled();
    })
  });

  it("geometry dialog should let you close the editor although the geojson isn\'t correct", function() {
    runs(function(){
      dialog.open();
    })

    waits(500);

    runs(function(){
      dialog.$el.find("textarea").val("fail!");
      dialog.$el.find("textarea").keyup();
      dialog.$el.find("a.ok").click();
      expect(dialog.hide).toHaveBeenCalled();
    })
  });

  it("geometry dialog should show a placeholder", function() {
    runs(function(){
      dialog.open();
    })

    waits(500);

    runs(function(){
    dialog.$el.find("textarea").val("");
    dialog.$el.find("textarea").keyup();
    expect(dialog.$('#geoJSONEditor').attr('placeholder')).toEqual('Insert your GEOJSON here');
    });

  });

  it("should update geojson editor when you change the lat/lon editor", function() {

    row = new cdb.admin.Row({cartodb_id: "1", isGeomLoaded: false, the_geom: null});
    dialog = new cdb.admin.EditGeometryDialog({
      el: $('<div>'),
      row: row,
      initial_value: '{"type":"Point","coordinates":["1","1"]}',
      readOnly: false
    });
    dialog.ok = function() {};
    dialog.cancel = function() {};
    dialog.hide = function() {};
    dialog.open();
    dialog.$('input.latitude').val(5).trigger('keyup');
    dialog.$('input.longitude').val(5).trigger('keyup');
    dialog.$('.disabled').click();

    expect(dialog.$('#geoJSONEditor').val()).toEqual('{"type":"Point","coordinates":["5","5"]}');
  })

  it("should update lat/lon editor when you change the geojson editor", function() {

    row = new cdb.admin.Row({cartodb_id: "1", isGeomLoaded: false, the_geom: null});
    dialog = new cdb.admin.EditGeometryDialog({
      el: $('<div>'),
      row: row,
      initial_value: "GeoJSON",
      readOnly: false
    });
    dialog.ok = function() {};
    dialog.cancel = function() {};
    dialog.hide = function() {};
    dialog.open();


    dialog.$('#geoJSONEditor').val('{"type":"Point","coordinates":["1","1"]}').trigger('keyup');
    dialog.updateInputs();

    expect(dialog.$('input.latitude').val()).toEqual("1");
    expect(dialog.$('input.longitude').val()).toEqual("1");
  })

  it("should request from server the data when it's not loaded on the row", function() {
    var called = false;
    row.set('the_geom', 'GeoJSON');
    row.fetch = function() { called = true;}
    dialog = new cdb.admin.EditGeometryDialog({
      el: $('<div>'),
      row: row,
      initial_value: "GeoJSON",
      readOnly: false
    });
    expect(called).toBeTruthy();
  })


});
