#===================================
#Manual TO-DO
# Currently Ansible 2.x is bugged and we can't connect via SSH so that we're using ansible 1.9.x
#
#IF aws:
#1. run in shell sudo su
#2. run in shell chmod u=+w /etc/sudoers
#3. Manually remove from /etc/sudoers Defaults requiretty
#3.1  mkdir /var/www; mkdir /var/www/html
#4. Run CircleCI and Ansible in the new machine for the very first time
#===================================

# Add a line to a file if it does not exist, without passing regexp

- name: Only run "update_cache=yes" if the last one is more than 3600 seconds ago
  apt:
    update_cache: yes
    cache_valid_time: 604800

- name: "FIX: Ubuntu 16.04 LTS doesn't come with certain modules, required by ansible"
  raw: apt-get install python-minimal aptitude -y
  become: true
  become_user: root
  become_method: sudo

- name: Cooking the system
  become: yes
  apt:
    name: "*"
    state: latest

- name: Cooking system encoding
  become: yes
  shell: sudo locale-gen en_US.UTF-8

- name: Cooking system locale
  become: yes
  shell: sudo update-locale LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8

- name: Cooking Python
  become: yes
  apt:
    name: python-software-properties
    state: latest

- name: Cooking autoconf >> latest
  become: yes
  apt:
    name: autoconf
    state: latest

- name: Cooking binutils-doc >> latest
  become: yes
  apt:
    name: binutils-doc
    state: latest

- name: Cooking bison >> latest
  become: yes
  apt:
    name: bison
    state: latest

- name: Cooking build-essential >> latest
  become: yes
  apt:
    name: build-essential
    state: latest

- name: Cooking flex >> latest
  become: yes
  apt:
    name: flex
    state: latest

- name: Cooking git >> latest
  become: yes
  apt:
    name: git
    state: latest

- apt_repository:
    repo: ppa:cartodb/postgresql-9.5

- apt_repository:
    repo: ppa:cartodb/gis

- apt_repository:
    repo: ppa:ubuntugis/ppa

- apt_repository:
    repo: ppa:cartodb/redis

- apt_repository:
    repo: ppa:cartodb/nodejs

- name: Mixing the ingredients
  apt:
    update_cache: yes

- name: Cooking libpq5 client >> latest
  become: yes
  apt:
    name: libpq5
    state: latest

- name: Cooking libpq-dev client >> latest
  become: yes
  apt:
    name: libpq-dev
    state: latest

- name: Cooking postgresql-client-9.5 client >> present
  become: yes
  apt:
    name: postgresql-client-9.5
    state: present


- name: Cooking postgresql-client-common client >> present
  become: yes
  apt:
    name: postgresql-client-common
    state: present

- name: Cooking postgresql-9.5 server >> present
  become: yes
  apt:
    name: postgresql-9.5
    state: present

- name: Cooking postgresql-contrib-9.5 server >> present
  become: yes
  apt:
    name: postgresql-contrib-9.5
    state: present

- name: Cooking postgresql-server-dev-9.5 server >> present
  become: yes
  apt:
    name: postgresql-server-dev-9.5
    state: present

- name: Cooking postgresql-plpython-9.5 server >> present
  become: yes
  apt:
    name: postgresql-plpython-9.5
    state: present